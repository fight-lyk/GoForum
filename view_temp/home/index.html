{{define "content"}}{{template "header" .}}
<link type="text/css" rel="stylesheet" href="/static/dist/css/snackbar.css">
{{template "header_foo" .}}
<main id="app" style="margin-bottom:72px"> <!--footer:60px-->
        <home-grid :home="home"></home-grid>
        <discover-grid :discover="discover"></discover-grid>
        <message-grid :message="message"></message-grid>
        <user-grid :user="me"></user-grid>
</main>
<!--home template-->
<script type="text/x-template" id="home-template">
  <div class="container" v-if="home.active">
      <div v-if="home.loaded">
          <h1>Home</h1>
          <div v-for="swipe in home.swipes">
              <a v-bind:href="{{"swipe.Url"}}" target="_blank">
                  <img class="img-responsive" alt="Loading" v-bind:src="{{"swipe.Img"}}"/>
              </a>
          </div>  <!--ends home.swipes-->
          <div v-for="hot in home.hot_posts">
               {{"{{hot.Title}}"}}
          </div>
          <a @click="loadMore('btn')" :disabled="!home.loading_enable">{{"{{home.hot_loading_text}}"}}</a>
      </div>
      <div v-else>
          <span>正在加载...</span>
      </div> <!--/home.loaded-->
  </div>  <!--/home.active-->
</script>
<!--discover template-->
<script type="text/x-template" id="discover-template">
  <div class="container" v-if="discover.active">
      <h1>discover</h1>
      <div v-for="topic in topics">
          {{"{{topic}}"}}
      </div>
  </div>
</script>
<!--message template-->
<script type="text/x-template" id="message-template">
  <div class="container" v-if="message.active">
      <h1>Nessage</h1>
      <div v-for="msg in messages">
          {{"{{msg}}"}}
      </div>
  </div>
</script>
<!--me template-->
<script type="text/x-template" id="user-template">
  <div class="container" v-if="user.active">
      <h1>Me</h1>
  </div>
</script>

{{template "tabbar" .}}
{{template "script" .}}
<script src="/static/dist/js/vue.js"></script>
<script src="/static/dist/js/snackbar.min.js"></script>
<script>
  var SHOW_HOME = 1,
   SHOW_DISCOVER = 2,
   SHOW_MESSAGE = 4,
   SHOW_ME = 8;

    Vue.component('home-grid', {
        template: '#home-template',
        props: {
            home: JSON
        },
        ready: function () {
        },
        data: function () {
            return {}
        },
        methods: {}
    });

     Vue.component('discover-grid', {
         template: '#discover-template',
         props: {
             discover: JSON
         },
         ready: function () {
         },
         data: function () {
             return {}
         },
         methods: {}
     });

     Vue.component('message-grid', {
         template: '#message-template',
         props: {
             message: JSON
         },
         ready: function () {
         },
         data: function () {
             return {}
         },
         methods: {}
     });

     Vue.component('user-grid', {
         template: '#user-template',
         props: {
             user: JSON
         },
         ready: function () {
         },
         data: function () {
             return {}
         },
         methods: {}
     });

    var vue = new Vue({
        el: "html",
        data: {
            title: "首页",
            home: {loaded: false,active:true,swipes:[],hot_posts:[],hot_start:0,hot_loading_text:"加载更多",hot_loading_enable:true},
            discover: {loaded: false,active:false},
            message: {loaded: false,active:false},
            me: {loaded: false,active:false},
            setting: {}
        },
        ready:function(){
           //init
        },
        methods: {
          //status = 1/2/4/8 only
            show:function(status){
              this.home.active = (status&SHOW_HOME) == SHOW_HOME;
              this.discover.active = (status&SHOW_DISCOVER) == SHOW_DISCOVER;
              this.message.active = (status&SHOW_MESSAGE) == SHOW_MESSAGE;
              this.me.active = (status&SHOW_ME) == SHOW_ME;
            },
            greetHome: function () {
                this.show(SHOW_HOME);
                if (!this.home.loaded) {
                   requestHomeData(this);
                }
            },
            greetDiscover: function () {
                this.show(SHOW_DISCOVER);
                if (!this.discover.loaded) {
                    console.log("no data");
                    this.discover.loaded = true;
                }
            },
            greetMessage: function () {
                this.show(SHOW_MESSAGE);
                if (!this.message.loaded) {
                    console.log("no data");
                    this.message.loaded = true;
                }
            },
            greetMe: function () {
                this.show(SHOW_ME);
                if (!this.me.loaded) {
                   console.log("no data");
                   this.me.loaded = true;
                }
            }
        }
    });

    //第一次加载失败(swipt 与 hot),可以通过点击首页重试
    function requestHomeData(self){
       $.ajax({
           type: 'GET',
           url: "/home/swipe/",
           success: function (data) {
               if (data.length == 0) { //todo
                   //  未找到相关内容;
               }
                self.home.swipes = []; //防止重试加载时会数据重叠
               data.forEach(function (e) {
                   self.home.swipes.push(e);
               });
               self.home.hot_loading_text = "正在加载";
               self.home.hot_loading_enable = false;
               requestHotPosts(self,self.home.hot_start);
           }, error: function (err) {
              // 加载失败,重新加载
               var options = {content: "加载失败,请<a href='#'>重试</a>", timeout: 2000};
               $.snackbar(options);
              //  console.log(err);
           }
       });
    }

    //请求热门帖子的数据
    //第一次由父组件调用,以后加载更多及失败的重试都由子组件负责
    function requestHotPosts(self,start){
      $.ajax({
          type: 'GET',
          url: "/home/hot/"+start,
          success: function (data) { //todo use try catch: data may be not json format
              if (data.length == 0) { //todo
                  self.home.hot_loading_enable = false;
                  self.home.hot_loading_text = "没有更多内容了";
                  return;
              }
              data.forEach(function (e) {
                  self.home.hot_posts.push(e);
              });
              self.home.loaded = true;
              self.home.hot_loading_text = "加载更多";
              self.home.hot_loading_enable = true;
          }, error: function (err) {
              self.home.hot_loading_enable = true;
              self.home.hot_loading_text = "加载失败,请重试";
              var options = {content: "加载失败,请重试", timeout: 2000};
              $.snackbar(options);
              // console.log(err);
          }
      });
    }

</script>
{{template "footer" .}}
{{end}}
